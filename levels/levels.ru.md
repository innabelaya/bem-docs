## Уровни переопределения

Уровень переопределения — это набор полных или частичных [реализаций](https://ru.bem.info/methodology/key-concepts/#Реализация-блока) [блоков](https://ru.bem.info/methodology/key-concepts/#Блок), [элементов](https://ru.bem.info/methodology/key-concepts/#Элемент) и [модификаторов](https://ru.bem.info/methodology/key-concepts/#Модификатор).

В файловой структуре проекта уровень переопределния выглядит как группирующая директория, которая содержит исходные файлы реализаций [БЭМ-сущностей](https://ru.bem.info/methodology/key-concepts/#БЭМ-сущность). 

```files
project/
    level/                              # уровень переопределния
        block1/                         # директория блока block1
            __elem1/                    # директория элемента elem1 блока block1
                block1__elem1.js        # исходный файл реализации элемента elem1 блока block1 в технологии JavaScript
            _mod1/                      # директория модификатора mod1 блока block1
                block1_mod1.css         # исходный файл реализации модификатора mod1 блока block1 в технологии CSS
            block1.css                  # исходный файл реализации блока block1 в технологии CSS
            block1.js                   # исходный файл реализации блока block1 в технологии JavaScript
        block2/                         # директория блока block2
            block2.css                  # исходный файл реализации блока block2 в технологии CSS
            block2.js                   # исходный файл реализации блока block1 в технологии JavaScript
        block3/
        block4/
```

> [Подробнее о файловой структуре БЭМ-проекта](https://ru.bem.info/methodology/filestructure/)

Любой БЭМ-проект включает минимум один уровень переопределения. Количество уровней и содержащийся в них набор БЭМ-сущностей могут меняться.

* [Функции уровней переопределения](#Зачем-нужны-уровни-переопределения)
* [Практическое применение](#Практическое-применение-уровней-переопределения)

## Зачем нужны уровни переопределения

Уровни переопределения дают возможность:

* [Расширять или перекрывать исходную реализацию](#Изменение-реализации-блока) БЭМ-сущностей без дублирования кода.
* [Подключать в проект дополнительные БЭМ-сущности](#Подключение-дополнительных-БЭМ-сущностей) (например, готовые блоки из сторонней библиотеки).

### Изменение реализации блока

В БЭМ-методологии реализация блока распределена по отдельным файлам технлогий (`button.css`, `button.js`, `button.tests`). Благодаря этому реализация блока в любой из технологий может быть разделена по разным уровням переопределения. Каждый дополнительный уровень добавляет новые свойства (доопределяет, наследует) блоку или изменяет старые (переопределяет).

Финальная реализация блока собирается со всех уровней последовательно в указанном порядке. Чтобы получить желаемый конечный результат, в настройках сборщика необходимо указать, с каких уровней и в каком порядке собирать исходные файлы. 

> **Примечание** Файлы, полученные в результате сборки, в БЭМ-методологии принято называть бандлами. Подробности [здесь](https://ru.bem.info/methodology/build/).

Для сборки бандла можно: 
* использовать любое множество уровней;
* задавать любой порядок подключения уровней в сборку.

> **Примечание** Уровни переопределения ведут себя аналогично слоям в графическом редакторе: базовый слой – это исходная реализация блока, а каждый последующий слой накладывается сверху и дополняет (наследует) или изменяет базовую реализацию.

Пример переопределения CSS-свойств блока:

```files
project/
    common/                # уровень переопределния common
        button/
            button.css
            button.js
    project/               # уровень переопределния project
        button/
            button.css
```

CSS-реализация

```css
/* Блок button в технологии CSS на уровне common */

.button {
    color: red;
    height: 24px;
}

/* Блок button в технологии CSS на уровне project */

.button {
    color: green;
    font-size: 11px;
}
```

В результате сборки: 
* переопределятся повторяющиеся свойства (`color`) для блока `button` (кнопка из красной превратится в зеленую);
* добавится новое свойство (`font-size`). 

```css
@import "common/button/button.css";    /* Базовые CSS-правила */
@import "project/button/button.css";   /* Особенности desktop */
```

Финальный результат для блока `button` в технологии CSS:

```css
/* Результат сборки блока button в технологии CSS */

.button {
    color: green;
    height: 24px;
    font-size: 11px;
}
```

> **Примечание** Можно переопределять не только CSS-свойства блока, но и его методы и шаблоны использования. В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробности в разделе [Платформа](https://ru.bem.info/platform/). 

### Подключение дополнительных БЭМ-сущностей

С помощью уровней переопределния можно не только изменять уже существующие БЭМ-сущности, но и добавлять новые.

Полная реализация блока может находится на отдельном уровне переопределения и подключаться в проект при сборке.

Рассмотрим пример, в котором доплнительные блоки расположены на другом уровне. 

```files
project/
    common/                             # уровень переопределния common
        button/
            button.css
            button.js
    project/                            # уровень переопределния project
        logo/                           # блок logo 
            logo.css                    # реализация блока logo в технологии CSS
```

Чтобы блок `logo` с уровня `project` попал в сборку бандла необходимо:

* указать блок `logo` в описании блоков, которые используются в построении бандла;
* подключить уровень переопределения `project` в настройках сборщика. 

```css
@import "common/button/button.css";     /* CSS-правила блока button */
@import "project/logo/logo.css";        /* CSS-правила блока logo */
```

> **Примечание** Страница строится на основании файла с описанием блоков, которые в нем используются ([декларации](https://ru.bem.info/methodology/declarations/)), и файла ([.bemjson](https://ru.bem.info/platform/bemjson/)), который указывает на расположение этих блоков на странице. Это исходный код самой страницы. Из него генерируются все необходимые для отображения файлы (`.css`, `.js` и другие). Если блок `logo` присутсвует в исходном коде для построения страницы, и в настройках сборщика указан уровень переопределения `project`, то блок `logo` будет включен в сборку.

### Добавление модификатора

Аналогичным способом можно добавлять элементы и модификаторы любому блоку. При этом внешний вид или поведение базового блока может измениться. 

Рассмотрим на примере добавления модификатора. 

```files
project/
    common/                             # уровень переопределния common
        button/
            button.css
            button.js
    project/                            # уровень переопределния project
        button/
            _theme/
                button_theme_gold.css   # блоку button добавлен модификатор theme в значении gold 
```

CSS-реализация

```css
/* Блок button в технологии CSS на уровне common */

.button {
    color: red;
    height: 24px;
}

/* Модификтаор theme в значении gold блока button в технологии CSS на уровне project */

.button_theme_gold {
    color: yellow;
    font-size: 11px;
    text-align: center;
}
```

Если в DOM-дереве на одном DOM-узле будут присутствовать блок `button` и его модификтор `theme` в значении `gold`, 

```html
<div class="button"></div>
<div class="button button_theme_gold"></div>
```

то результирующий файл CSS для блока `button` будет:

```css
/* Результат сборки блока button в технологии CSS */

.button {
    color: yellow;
    height: 24px;
    font-size: 11px;
    text-align: center;
}
```

### Практическое применение уровней переопределения

Помимо того, что уровни помогают избежать копирования кода и создания новых сущностей при необходимости изменить уже существующую функциональность, они позволяют организовать архитектуру проекта таким образом, чтобы:

* [Подключать библиотеки](#Проект-и-библиотеки) и обновлять их, не делая правок в коде.
* [Выделять общие части реализаций блоков](#Изменения-в-типовых-проектах) на один уровень, а частные случаи (например, специфическую реализацию для отдельных сервисов) — на другой.
* [Разделять проект на платформы](#Разделение-проекта-на-платформы). Общую реализацию для всех платформ хранить на одном уровне, а платформо-специфичную — выносить на другой.
* [Экспериментировать](#Проект-и-эксперименты) в рабочем проекте.
* [Иметь разные дизайны проекта](#Проект-и-дизайн) с одной и той же бизнесс-логикой.

### Проект и библиотеки

В проект можно подключать библиотеку как отдельный уровень и изменять (до- или переопределять) блоки из этой библиотеки на другом уровне. При сборке подключится исходная реализация блоков с уровня библиотеки и переопределенная — с уровня проекта.

Такое разделение позволяет сохранить изменения в блоках при обновлении библиотеки. Код самой библиотеки обновится, а специфическая реализация блоков проекта останется прежней, так как находится на другом уровне проекта.

```files
library.blocks/
    button/
        button.css    # CSS-реализация кнопки в библиотеке (высота 20px)

project.blocks/
    button/
        button.css    # Переопределение на уровне проекта (высота 24px)
```

### Изменения в типовых проектах

Уровни переопределния используются для создания типовых проектов или, например, порталов, содержащих похожие страницы. 

При разработке одного сайта на основе существующего может потребоваться изменить блоки (пере- или доопределить) в разных технологиях только для определенного сайта или только для определенных страниц. Например, увеличить шрифт в шапке или добавить новый блок. Это возможно благодаря уровням переопределения.

```files
project/                            # общие блоки для всего сайта
    blocks/
        head/
            head.css
            head.js
        foot/
            foot.css
        sidebar/
            sidebar.css
            sidebar.js
    pages/                          # специфика реализации для отдельных страниц
        index/
            head/
                head.css            # переопределили шрифт в шапке на заглавной странице
        about/
            about-text/             # добавили новый блок
                about-text.css
```

Реализация блоков, одинаковая для всех страниц, располагается на уровне `common`, а все изменения для отдельных страниц раскладываются по уровням переопределения. Таким образом общий код на уровне `common` всегда обособлен и может изменяться, а специфические реализации отдельных страниц остаются неизменной. 

### Разделение проекта на платформы

Файловая структрура проекта, поддерживающего разные платформы (например, `mobile` и `touch`), может быть разделена по уровням:
* common — содержит общую реализацию блоков для всех платформ;
* touch — включает специфику реализаций блоков для сенсорных устройств;
* mobile — включает специфику реализаций блоков для мобильных устройств.

Рассмотрим на примере:

```files
common.blocks/
    button/
        button.css    # Базовая CSS-реализация кнопки

touch.blocks/
    button/
        button.css    # Особенности кнопки для touch

mobile.blocks/
    button/
        button.css    # Особенности кнопки для mobile
```

При сборке в файл `touch.css` попадут все базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `desktop`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "touch.blocks/button/button.css";   /* Особенности touch */
```

Файл `mobile.css` будет включать базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `mobile`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "mobile.blocks/button/button.css";    /* Особенности mobile */
```

### Проект и эксперименты

Уровни переопределения позволяют проводить A/B тестирование непосредственно на рабочем проекте. При этом код самого проекта не меняется. 

Рассмотрим пример, когда проект уже запущен, и поступил запрос на доработку функциональности. Например, заказчик просит изменить отображение всех логотипов пользователя на всех страницах сайта и предлагает несколько вариантов: круг и квадрат. Необходимо провести тестирование и выбрать наиболее подходящий вариант. 

В большинстве проектов без уровней переопределения необходимо:
* найти все случаи использования блока `logo` на каждой странице;
* написать для каждого случая регулярное выражение с `if`;  
    ```js
      if (пользователь попал в эксперимент 'круг')
      {
      отобрази логотипы пользователей в круглыми;
      };
      if (пользователь попал в эксперимент 'квадрат')
      {
      отобрази логотипы пользователей в квадратными;
      };
    ```
* выбрать финальный вариант;
* возможно понять, что ни один вариант не подходит, и продолжить эксперименты с новыми вариантамии;
* удалить изменения для каждого случая на каждой странице;
* применить выбранные изменения.

Чтобы провести такое тестирование в БЭМ-проекте необходимо:
* создать отдельный уровень переопределения с изменениями блока (один эксперимент = один уровень переопределения);
* собрать проект для каждого эксперимента;
* выбрать финальный вариант;
* удалить уровни с неудачными экспериментами. 

При этом во время тестирования код рабочего проекта не изменяется.  

```files
project/            # рабочий код проекта
    logo/           # блок `logo`
    ...
test-circle/        # уровень для эксперимента 'круг'
    logo/           # блок `logo` с изменениями 
test-square/        # уровень для эксперимента 'квадрат'
    logo/           # блок `logo` с изменениями 
test-n/             # уровень для  любого нового эксперимента
    logo/           # блок `logo` с изменениями
```

### Проект и дизайн

Поведение и внешний вид проекта могут быть разделены на разные уровни переопределения. Бизнес-логика не меняется в зависимости от переключения дизайна, поэтому находится на отдельном уровне (`common`). Код, отвечающий за внешний вид проекта, вынесен на уровень дизайна (`design`).

```files
common/             # бизнес-логика проекта
    button/
    input/
    ...
design/             # внешний вид проекта
    alfa/           # дизайн проекта alfa
    beta/           # дизайн проекта beta
```

Для добавления нового дизайна необходимо создать дополнительный уровень переопределения, пере- или доопределить существующие блоки и включить данный уровень в сборку.
